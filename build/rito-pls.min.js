/*! ritopls v140426 by Bruce Caldwell @link(https://github.com/BruceCaldwell/ritopls). Minified by Uglify on: 26-04-2014 */
ritoPls=exports,ritoPlsUtils={},function(a){a.utils={};var b=require(__dirname+"/config.json").chunkSize;a.utils.fixNames=function(b,c){return b instanceof Array?b.forEach(function(c,d){b[d]=a.utils.fixNames(c)}):(b=b.toString().trim().replace(/\s+/g,"").toLowerCase(),c&&(b=c(b))),b},a.utils.chunkArray=function(a){return[].concat.apply([],a.map(function(c,d){return d%b?[]:[a.slice(d,d+b)]}))},a.utils.maybeParseJson=function(a,b){try{var c=JSON.parse(a);b&&b(c)}catch(d){b&&b(a)}return c?c:a},a.utils.removeArrayElement=function(a,b){return a.splice(b,1),a}}(ritoPlsUtils),function(a){a.sql={};var b=require("mysql"),c=a.utils,d=require(__dirname+"/config.json").sql,e=b.createConnection(d);e.connect(function(d){if(d)throw"ritopls: Fatal Error: Could not connect to SQL database!";var f=function(a,b){e.query(a,function(a,d){a?b(!1):d[0]&&d[0].value?c.maybeParseJson(d[0].value,b):b(!1)})};!function(){var a="CREATE TABLE IF NOT EXISTS `user_cache_meta` (`riot_id` varchar(100) COLLATE utf8_unicode_ci NOT NULL,`region` varchar(5) COLLATE utf8_unicode_ci NOT NULL,`data_name` varchar(20) COLLATE utf8_unicode_ci NOT NULL,`value` longtext COLLATE utf8_unicode_ci NOT NULL,UNIQUE KEY `riot_id_UNIQUE` (`riot_id`,`region`,`data_name`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;";f(a,function(){})}(),a.sql.get=function(a,c,d,e){var g,h;switch(a){case"recent":a="games",g="SELECT ?? FROM ?? WHERE ??=? AND ??=? AND ??=?",h=["value","user_cache_meta","riot_id",c,"region",d,"data_name",a];break;case"stats":a="summary",g="SELECT ?? FROM ?? WHERE ??=? AND ??=? AND ??=?",h=["value","user_cache_meta","riot_id",c,"region",d,"data_name",a];break;case"runes":case"masteries":case"leagues":case"ranked":case"summary":case"games":case"teams":g="SELECT ?? FROM ?? WHERE ??=? AND ??=? AND ??=?",h=["value","user_cache_meta","riot_id",c,"region",d,"data_name",a];break;default:return void e(!1)}g&&h?f(b.format(g,h),e):e(!1)},a.sql.removeSummonerInfo=function(a,c){var d="DELETE FROM ?? WHERE ??=? AND ??=?",e=["user_cache_meta","riot_id",a,"region",c];d=b.format(d,e),f(d,function(){})},a.sql.add=exports.insert=function(a,b,c,d){var e,f;switch(a){case"recent":a="games",e="INSERT INTO ?? (??, ??, ??, ??) VALUES (?, ?, ?, ?)",f=["user_cache_meta","riot_id","region","data_name","value",b,c,a,JSON.stringify(d)];break;case"stats":a="summary",e="INSERT INTO ?? (??, ??, ??, ??) VALUES (?, ?, ?, ?)",f=["user_cache_meta","riot_id","region","data_name","value",b,c,a,JSON.stringify(d)];break;case"runes":case"masteries":case"leagues":case"ranked":case"summary":case"games":case"teams":e="INSERT INTO ?? (??, ??, ??, ??) VALUES (?, ?, ?, ?)",f=["user_cache_meta","riot_id","region","data_name","value",b,c,a,JSON.stringify(d)]}}})}(ritoPlsUtils),function(a){a.riot={};var b=require("http"),c=a.utils,d=require(__dirname+"/config.json").apiKey,e=require(__dirname+"/config.json").ignoreFatal,f=function(a,c){var f={host:"prod.api.pvp.net",port:80,path:"/api/lol"+a};f.path=-1!==f.path.indexOf("?")?f.path+"&api_key="+d:f.path+"?api_key="+d;var g=b.get(f,function(a){if(200===a.statusCode){var b="";a.on("data",function(a){b+=a}),a.on("end",function(){c(JSON.parse(b))})}else g.abort(),c({error:!0,code:a.statusCode})}).on("error",function(a){if(!e)throw"ritopos: Fatal Error: Node.js HTTP Error: "+a})};a.riot.summoner=function(a,b,c,d){var e;switch(a){case"summary":case"stats":e="/"+c+"/v1.3/stats/by-summoner/"+b+"/summary";break;case"ranked":e="/"+c+"/v1.3/stats/by-summoner/"+b+"/ranked";break;case"recent":case"games":e="/"+c+"/v1.3/game/by-summoner/"+b+"/recent";break;case"leagues":case"elo":e="/"+c+"/v2.3/league/by-summoner/"+b+"/entry";break;case"teams":e="/"+c+"/v2.2/team/by-summoner/"+b}e?f(e,d):d(!1)},a.riot.basicObjsByName=function(a,b,d){a=c.fixNames(a,encodeURIComponent);var e=a.join(),g="/"+b+"/v1.4/summoner/by-name/";f(g+e,d)},a.riot.basicObjsById=function(a,b,c){var d=a.join(),e="/"+b+"/v1.4/summoner/";f(e+d,c)},a.riot.runes=function(a,b,c){a instanceof Array&&(a=a.join());var d="/"+b+"/v1.4/summoner/"+a+"/runes";f(d,c)},a.riot.masteries=function(a,b,c){a instanceof Array&&(a=a.join());var d="/"+b+"/v1.4/summoner/"+a+"/masteries";f(d,c)},a.riot.teamStats=function(a,b,c){a instanceof Array&&(a=a.join());var d="/"+b+"/v2.2/team/"+a;f(d,c)}}(ritoPlsUtils),function(a){a.cache={};var b=a.utils,c=a.sql.removeSummonerInfo,d=require(__dirname+"/config.json").caching,e={na:{},br:{},euw:{},eune:{},lan:{},las:{},oce:{}};a.cache.add=function(a,c,d){d.timeAdded=(new Date).getTime(),d.timeChecked=(new Date).getTime(),d.region=c,e[c][b.fixNames(a)]=d},a.cache.getUserBasic=function(a,c){return a=b.fixNames(a),e[c].hasOwnProperty(a)?e[c][a]:!1},a.cache.getOldUsers=function(){var a=[];for(var b in e)if(e.hasOwnProperty(b))for(var c in e[b])if(e[b].hasOwnProperty(c)){var f=e[b][c];(new Date).getTime()-f.timeChecked>d.allowedTimeSQL&&a.push(f)}return a},a.cache.bringUserDateUp=function(a,c){a=b.fixNames(a),e[c].hasOwnProperty(a)&&(e[c][a].timeChecked=(new Date).getTime())},setInterval(function(){var a=(new Date).getTime();for(var b in e)if(e.hasOwnProperty(b))for(var f in e[b])if(e[b].hasOwnProperty(f)){var g=e[b][f];a-g.timeAdded>d.allowedTimeBasic&&(c(e[b][f].id,e[b][f].region),delete e[b][f])}},d.checkTimeBasic)}(ritoPlsUtils),function(a){a.get={};var b=a.riot,c=a.cache,d=a.utils,e=a.sql,f=require(__dirname+"/config.json");jsonObj='{"na":{"ids":[],"name":"na"},"br":{"ids":[],"name":"br"},"euw":{"ids":[],"name":"na"},"eune":{"ids":[],"name":"na"},"lan":{"ids":[],"name":"lan"},"las":{"ids":[],"name":"las"},"oce":{"ids":[],"name":"oce"},"kr":{"ids":[],"name":"kr"},"ru":{"ids":[],"name":"ru"},"tr":{"ids":[],"name":"tr"}}';var g=JSON.parse(jsonObj),h=JSON.parse(jsonObj),i=JSON.parse(jsonObj),j=JSON.parse(jsonObj);a.get.basicByName=function(a,b,e){var f;(f=c.getUserBasic(a=d.fixNames(a),b))?e(f):g[b].ids.push({name:a,func:e})},a.get.runes=function(a,b,c){e.get("runes",a,b,function(d){d?c(d):h[b].ids.push({id:a,func:c})})},a.get.masteries=function(a,b,c){e.get("masteries",a,b,function(d){d?c(d):i[b].ids.push({id:a,func:c})})},a.get.teams=function(a,b,c){e.get("teams",a,b,function(d){d?c(d):j[b].ids.push({id:a,func:c})})},a.get.ranked=function(a,b,c){k("ranked",a,b,c)},a.get.summary=function(a,b,c){k("summary",a,b,c)},a.get.games=function(a,b,c){k("games",a,b,c)},a.get.leagues=function(a,b,c){k("leagues",a,b,c)};var k=function(a,c,d,f){e.get(a,c,d,function(g){g?f(g):b.summoner(a,c,d,function(b){b&&e.add(a,c,d,b),f(b)})})},l=function(a,f){var g=d.chunkArray(a.ids);g.forEach(function(d){var g=[];switch(d.forEach(function(a){g.push("ids"===f?encodeURIComponent(a.name):encodeURIComponent(a.id))}),f){case"ids":b.basicObjsByName(g,a.name,function(b){b||(b={}),d.forEach(function(d){b.hasOwnProperty(d.name)?(c.add(d.name,a.name,b[d.name]),d.func(b[d.name])):d.func(!1)})});break;case"runes":b.runes(g,a.name,function(b){b||(b={}),d.forEach(function(c){b.hasOwnProperty(c.id)?(e.add("runes",c.id,a.name,b[c.id]),c.func(b[c.id])):c.func(!1)})});break;case"masteries":b.masteries(g,a.name,function(b){b||(b={}),d.forEach(function(c){b.hasOwnProperty(c.id)?(e.add("masteries",c.id,a.name,b[c.id]),c.func(b[c.id])):c.func(!1)})});break;case"teams":b.teamStats(g,a.name,function(b){b||(b={}),d.forEach(function(c){b.hasOwnProperty(c.id)?(e.add("teams",c.id,a.name,b[c.id]),c.func(b[c.id])):c.func(!1)})})}})};setInterval(function(){var a=["na","br","euw","eune","lan","las","oce","kr","ru","tr"];a.forEach(function(a){g[a].ids.length>0&&l(g[a],"ids"),h[a].ids.length>0&&l(h[a],"runes"),i[a].ids.length>0&&l(i[a],"masteries"),j[a].ids.length>0&&l(i[a],"teams")}),g=JSON.parse(jsonObj),h=JSON.parse(jsonObj),i=JSON.parse(jsonObj),j=JSON.parse(jsonObj)},f.chunkTiming),setInterval(function(){var a=c.getOldUsers();a.forEach(function(a){c.bringUserDateUp(a.name,a.region),e.removeSummonerInfo(a.id,a.region)})},f.caching.checkTimeSQL)}(ritoPlsUtils),function(a){var b=a.utils,c=a.get,d=(require("util"),require("events").EventEmitter),e=exports.Emitter=new d;e.setMaxListeners(0),ritoPls.getFullSummonerByName=function(a,c){a=b.fixNames(a);var g=new d,h=function(a){g.emit("ready",a),j()},i=function(a){g.emit("error",a),j()},j=function(){e.removeListener(a+"-ready",h),e.removeListener(a+"-error",i),g.removeAllListeners()};return e.on(a+"-ready",h),e.on(a+"-error",i),f(a,c),g},ritoPls.getBasicInfoByName=function(){};var f=function(a,d){var f={id:{id:0,desc:"Failed to retrieve summoner basic info object."},runes:{id:1,desc:"Failed to retrieve summoner runes."},masteries:{id:2,desc:"Failed to retrieve summoner masteries."},ranked:{id:3,desc:"Failed to retrieve summoner ranked stats."},summary:{id:4,desc:"Failed to retrieve summoner stats summary."},games:{id:5,desc:"Failed to retrieve summoner recent games."},leagues:{id:6,desc:"Failed to retrieve summoner league info."}};a=b.fixNames(a),c.basicByName(a,d,function(g){g&&g.name||e.emit(a+"-error",f.id);var h=JSON.parse(JSON.stringify(g)),i=["runes","masteries","ranked","summary","games","leagues"],j=function(c){var d=i.indexOf(c);-1!==d&&(i=b.removeArrayElement(i,d)),0===i.length&&e.emit(a+"-ready",h)};c.runes(h.id,d,function(b){!b||b.error?e.emit(a+"-error",f.runes):(h.runes=b,j("runes"))}),c.masteries(h.id,d,function(b){!b||b.error?e.emit(a+"-error",f.masteries):(h.masteries=b,j("masteries"))}),c.ranked(h.id,d,function(b){!b||b.error?e.emit(a+"-error",f.ranked):(h.ranked=b,j("ranked"))}),c.summary(h.id,d,function(b){!b||b.error?e.emit(a+"-error",f.summary):(h.summary=b,j("summary"))}),c.games(h.id,d,function(b){!b||b.error?e.emit(a+"-error",f.games):(h.games=b.games,j("games"))}),c.leagues(h.id,d,function(b){!b||b.error?e.emit(a+"-error",f.leagues):(h.leagues=b,j("leagues"))})})}}(ritoPlsUtils);